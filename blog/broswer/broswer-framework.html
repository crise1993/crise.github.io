<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一文搞定浏览器架构 | crise&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="./assets/logo.png">
    <meta name="description" content="一名程序员/前端人的技术博客">
    
    <link rel="preload" href="/assets/css/0.styles.1cd9ab6a.css" as="style"><link rel="preload" href="/assets/js/app.9120daf7.js" as="script"><link rel="preload" href="/assets/js/2.a6e094ff.js" as="script"><link rel="preload" href="/assets/js/8.9f6f4f79.js" as="script"><link rel="prefetch" href="/assets/js/10.d9b6c9f9.js"><link rel="prefetch" href="/assets/js/11.0c6ce840.js"><link rel="prefetch" href="/assets/js/12.a569ee67.js"><link rel="prefetch" href="/assets/js/13.241e980e.js"><link rel="prefetch" href="/assets/js/14.6926c1c5.js"><link rel="prefetch" href="/assets/js/15.be6a274d.js"><link rel="prefetch" href="/assets/js/16.0b9d8c28.js"><link rel="prefetch" href="/assets/js/17.45f356c9.js"><link rel="prefetch" href="/assets/js/18.5e50c60e.js"><link rel="prefetch" href="/assets/js/19.d739307b.js"><link rel="prefetch" href="/assets/js/20.03fd2cc0.js"><link rel="prefetch" href="/assets/js/21.5f1ef20a.js"><link rel="prefetch" href="/assets/js/22.5864a5a2.js"><link rel="prefetch" href="/assets/js/23.a0cc2704.js"><link rel="prefetch" href="/assets/js/24.69403470.js"><link rel="prefetch" href="/assets/js/25.275403bb.js"><link rel="prefetch" href="/assets/js/26.b1286bc4.js"><link rel="prefetch" href="/assets/js/27.3693eee6.js"><link rel="prefetch" href="/assets/js/28.fc3366b7.js"><link rel="prefetch" href="/assets/js/29.21f2e63a.js"><link rel="prefetch" href="/assets/js/3.f3817cd8.js"><link rel="prefetch" href="/assets/js/30.8caa22a5.js"><link rel="prefetch" href="/assets/js/31.f50f5254.js"><link rel="prefetch" href="/assets/js/32.90a406de.js"><link rel="prefetch" href="/assets/js/33.deb5b238.js"><link rel="prefetch" href="/assets/js/34.07b65d54.js"><link rel="prefetch" href="/assets/js/35.8af4d320.js"><link rel="prefetch" href="/assets/js/36.5efae40e.js"><link rel="prefetch" href="/assets/js/37.06625c30.js"><link rel="prefetch" href="/assets/js/38.8b134306.js"><link rel="prefetch" href="/assets/js/39.02668970.js"><link rel="prefetch" href="/assets/js/4.9b118658.js"><link rel="prefetch" href="/assets/js/40.a27fd44a.js"><link rel="prefetch" href="/assets/js/41.47ba2003.js"><link rel="prefetch" href="/assets/js/42.ea8fb56c.js"><link rel="prefetch" href="/assets/js/43.10454bb8.js"><link rel="prefetch" href="/assets/js/44.530dcfdd.js"><link rel="prefetch" href="/assets/js/45.d6b0fddd.js"><link rel="prefetch" href="/assets/js/46.d00976be.js"><link rel="prefetch" href="/assets/js/47.f7ddf21d.js"><link rel="prefetch" href="/assets/js/48.8e0f5c0b.js"><link rel="prefetch" href="/assets/js/49.db4b8f3a.js"><link rel="prefetch" href="/assets/js/5.3fc413d1.js"><link rel="prefetch" href="/assets/js/50.3d9e2fd6.js"><link rel="prefetch" href="/assets/js/51.7e919ad6.js"><link rel="prefetch" href="/assets/js/52.cc8a9467.js"><link rel="prefetch" href="/assets/js/53.27bab2ed.js"><link rel="prefetch" href="/assets/js/54.7b4fb7b1.js"><link rel="prefetch" href="/assets/js/55.b0e7b8e7.js"><link rel="prefetch" href="/assets/js/56.50b150de.js"><link rel="prefetch" href="/assets/js/57.fcb73728.js"><link rel="prefetch" href="/assets/js/58.63e48b57.js"><link rel="prefetch" href="/assets/js/59.01ea8047.js"><link rel="prefetch" href="/assets/js/6.a0219e38.js"><link rel="prefetch" href="/assets/js/60.f61f9001.js"><link rel="prefetch" href="/assets/js/61.6f01a24f.js"><link rel="prefetch" href="/assets/js/62.34e0934b.js"><link rel="prefetch" href="/assets/js/63.628b798d.js"><link rel="prefetch" href="/assets/js/64.bee0e2cb.js"><link rel="prefetch" href="/assets/js/65.f1998917.js"><link rel="prefetch" href="/assets/js/66.44307c2a.js"><link rel="prefetch" href="/assets/js/67.8a468a11.js"><link rel="prefetch" href="/assets/js/68.b746e204.js"><link rel="prefetch" href="/assets/js/69.ddd22bf9.js"><link rel="prefetch" href="/assets/js/7.6c6e1e69.js"><link rel="prefetch" href="/assets/js/70.d34188c1.js"><link rel="prefetch" href="/assets/js/71.b791990a.js"><link rel="prefetch" href="/assets/js/72.e027f464.js"><link rel="prefetch" href="/assets/js/73.5be25235.js"><link rel="prefetch" href="/assets/js/74.948d9afc.js"><link rel="prefetch" href="/assets/js/75.0088160a.js"><link rel="prefetch" href="/assets/js/76.38e00a2e.js"><link rel="prefetch" href="/assets/js/9.abcfea03.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1cd9ab6a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">crise's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法题库
</a></div><div class="nav-item"><a href="https://baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微博
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法题库
</a></div><div class="nav-item"><a href="https://baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微博
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>js进阶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>浏览器</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/broswer/broswer-framework.html" aria-current="page" class="active sidebar-link">一文搞定浏览器架构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/broswer/broswer-framework.html#浏览器单进程架构" class="sidebar-link">浏览器单进程架构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/broswer/broswer-framework.html#优点" class="sidebar-link">优点</a></li><li class="sidebar-sub-header"><a href="/blog/broswer/broswer-framework.html#单进程模型的局限性" class="sidebar-link">单进程模型的局限性</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/broswer/broswer-framework.html#浏览器多进程架构" class="sidebar-link">浏览器多进程架构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/broswer/broswer-framework.html#chrome多进程介绍" class="sidebar-link">Chrome多进程介绍</a></li><li class="sidebar-sub-header"><a href="/blog/broswer/broswer-framework.html#多进程架构优势" class="sidebar-link">多进程架构优势</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/broswer/broswer-framework.html#参考文档" class="sidebar-link">参考文档</a></li></ul></li><li><a href="/blog/broswer/kernel.html" class="sidebar-link">一文看懂浏览器内核</a></li><li><a href="/blog/broswer/useragent.html" class="sidebar-link">浏览器和UserAgent发展史</a></li><li><a href="/blog/broswer/compatibility.html" class="sidebar-link">浏览器兼容性问题研究</a></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>http</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/broswer/http.html" class="sidebar-link">一文读懂http</a></li><li><a href="/blog/broswer/http-cache.html" class="sidebar-link">浏览器缓存机制</a></li><li><a href="/blog/broswer/https.html" class="sidebar-link">深入理解HTTPS</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>原理篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/broswer/website-navigation.html" class="sidebar-link">从浏览器输入网址到页面加载，中间发生了什么？</a></li><li><a href="/blog/broswer/render-mechanism.html" class="sidebar-link">浏览器渲染原理</a></li><li><a href="/blog/broswer/js-mechanism.html" class="sidebar-link">JS执行机制</a></li><li><a href="/blog/broswer/reflow-repaint-composite.html" class="sidebar-link">一文看懂浏览器重排、重绘与合成</a></li><li><a href="/blog/broswer/compositor-layer-manage.html" class="sidebar-link">合成层优化</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端工程化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>web跨端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>框架及原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>运维相关</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="一文搞定浏览器架构"><a href="#一文搞定浏览器架构" class="header-anchor">#</a> 一文搞定浏览器架构</h1> <p>浏览器的主要功能就是向服务器发出请求，在浏览器窗口中展示您选择的网络资源。这里所说的资源一般是指 HTML 文档，也可以是 PDF、图片视频或其他的类型。资源的位置由用户使用 URI（统一资源标示符）指定。</p> <p>如果你是一名前端开发者，那么你每天和浏览器相处的时间甚至要超过你的女朋友。甚至就连你一直无法舍弃的VSCode编辑器，也和浏览器有着莫大的联系。</p> <p>本文主要聊聊浏览器的单进程/多进程架构模型，以及浏览器多进程架构优势。至于想了解浏览器内核的构成，可以点击查看<a href="/blog/broswer/kernel.html#内核构成">一文搞定浏览器内核</a>。</p> <h2 id="浏览器单进程架构"><a href="#浏览器单进程架构" class="header-anchor">#</a> 浏览器单进程架构</h2> <p>浏览器的单进程模型是一种早期的浏览器架构，它在浏览器的整个生命周期中只使用一个进程来管理所有的标签页、插件和扩展。这意味着无论是浏览网页、执行 JavaScript、处理用户输入还是管理插件和扩展，所有的任务都由同一个进程负责。</p> <h3 id="优点"><a href="#优点" class="header-anchor">#</a> 优点</h3> <h4 id="简单性"><a href="#简单性" class="header-anchor">#</a> 简单性</h4> <p>单进程模型的最大优点在于其简单性。由于只有一个进程在运行，因此管理和调度任务相对简单，不需要复杂的进程间通信或数据同步机制。这使得浏览器的设计和实现变得更加简单和直接。</p> <h3 id="单进程模型的局限性"><a href="#单进程模型的局限性" class="header-anchor">#</a> 单进程模型的局限性</h3> <h4 id="性能问题"><a href="#性能问题" class="header-anchor">#</a> 性能问题</h4> <p>然而，单进程模型也存在一些局限性。最显著的是性能问题。由于所有的任务都在同一个进程中运行，当处理多个标签页或插件时，各个任务相互竞争抢夺CPU资源，这可能会导致浏览器的响应速度变慢，甚至出现卡顿现象。</p> <h4 id="安全性风险"><a href="#安全性风险" class="header-anchor">#</a> 安全性风险</h4> <p>所有打开的标签页、插件和扩展共享相同的进程和系统资源，这意味着它们之间可以直接共享内存和数据。这就带来安全性风险。由于所有的内容都在同一个进程中运行，因此存在一个标签页或插件可能会访问其他标签页或插件的敏感数据，这就可能导致安全漏洞和用户数据泄露的风险。</p> <h2 id="浏览器多进程架构"><a href="#浏览器多进程架构" class="header-anchor">#</a> 浏览器多进程架构</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>chrome浏览器的<code>blink内核</code>在<code>webkit内核</code>基础上采用了多进程架构，safari浏览器最开始使用的是单进程，后来<code>webkit</code>升级成<code>webkit2</code>之后，也采用了多进程架构。</p></div> <p>使用IPC通信的多进程架构正好规避了这些缺点。通过将不同类型的任务分配到不同的进程中，浏览器多进程架构可以在某些情况下提供更好的性能和安全性。然而，这也会引入一些额外的系统开销，例如进程间通信和资源分配。因此，浏览器制造商需要在设计中权衡这些因素，以实现最佳的用户体验。不同浏览器可能在实现多进程架构时略有不同，但通常遵循类似的原则。</p> <h3 id="chrome多进程介绍"><a href="#chrome多进程介绍" class="header-anchor">#</a> Chrome多进程介绍</h3> <p>如果您想查看 Chrome 中正在运行的进程数量，可以通过chrome窗口选项中的任务管理器进行查看。其中列出了当前正在运行的进程以及它们的内存占用空间以及CPU使用率。
<img src="/assets/img/chrome-process.423213ec.png" alt="chrome多进程"> 
当我们是要浏览一个网页，我们会在浏览器的地址栏里输入URL，这个时候<code>Browser Process</code>会向这个URL发送请求，获取这个URL的HTML内容，然后将HTML交给<code>Renderer Process</code>，<code>Renderer Process</code>解析HTML内容，解析遇到需要请求网络的资源又返回来交给Browser Process进行加载，同时通知<code>Browser Process</code>，需要<code>Plugin Process</code>加载插件资源，执行插件代码。解析完成后，<code>Renderer Process</code>计算得到<code>合成帧（compositor frame）</code>，并将这些合成帧交给<code>GPU Process</code>，<code>GPU Process</code>将其转化为图像显示屏幕。</p> <p>从上图可以看出，在Chrome中，主要的进程类型有4种：</p> <h4 id="浏览器主进程-browser-process"><a href="#浏览器主进程-browser-process" class="header-anchor">#</a> 浏览器主进程 (Browser Process)</h4> <blockquote><p>包括绘制浏览器按钮和输入字段的 <code>UI线程</code>、处理网络堆栈以从Internet接收数据的 <code>网络线程</code>、控制对文件的访问的<code>存储线程</code>等。当您在地址栏中键入 URL 时，您的输入由浏览器进程的 UI 线程处理。</p></blockquote> <p>主进程是 Chrome 浏览器的核心，负责协调和管理浏览器以及页面的整个生命周期。主要功能如下：</p> <ul><li><red>用户界面管理</red>：负责处理浏览器的用户界面，包括地址栏、书签栏、后退/前进按钮、标签页的打开和关闭等用户界面操作。</li> <li><red>IPC进程通信</red>：负责启动、创建和销毁其他类型的进程（包括渲染进程、GPU 进程、插件进程、实用程序进程等），以及与其他进程之间进行通信，以确保它们之间的协调运作。</li> <li><red>网络请求和资源管理</red>：还处理 Web 浏览器的不可见的特权部分，例如网络请求、域名解析、文件访问、Cookie 管理等；协调网络资源的下载、加载和处理，以确保用户获取所需的内容。</li> <li><red>插件和扩展管理</red>：负责管理浏览器的扩展和插件系统，处理插件的加载、运行和交互；确保插件和扩展不会影响浏览器的稳定性和安全性。</li> <li><red>安全性和权限管理</red>：负责管理浏览器的安全性，包括沙盒环境的设置和维护，以防止恶意代码对系统的访问；还负责处理用户权限，确保用户数据的隐私和保护。
</li></ul> <p>在内存资源足够时，浏览器进程会将网络线程、存储线程、设备线程等拆分成单独的 <code>实用程序进程（Utility Process）</code>（<underline>Utility Process 是一种特殊类型的进程，用于执行一些特定的任务和功能。实用进程执行不同于渲染页面内容的任务，这些任务可能需要较高的特权级别或访问系统资源</underline>），甚至UI线程以及每个用到的 <code>扩展程序（Extension Process）</code> 都会创建一个单独的进程。</p> <h5 id="ui-process-ui进程"><a href="#ui-process-ui进程" class="header-anchor">#</a> UI Process（UI进程）</h5> <ul><li>UI进程负责管理和绘制浏览器的用户界面元素，如地址栏、标签页、按钮、工具栏等。</li> <li>将GPU合成处理后的<code>bitMap(位图)</code>，呈现到用户界面上，它确保界面元素正确显示、布局和交互，以便用户可以与浏览器进行交互。</li></ul> <h5 id="network-service-网络进程"><a href="#network-service-网络进程" class="header-anchor">#</a> Network Service（网络进程）</h5> <ul><li>网络服务进程负责处理所有网络请求，包括发送和接收 HTTP 请求。</li> <li>这个进程在一个独立的沙盒环境中运行，将网络请求与其他进程隔离开来，以增加安全性并防止恶意代码访问用户的敏感数据。</li> <li>网络服务进程也处理域名解析、代理设置和其他与网络通信相关的任务。</li></ul> <h5 id="storage-service-存储进程"><a href="#storage-service-存储进程" class="header-anchor">#</a> Storage Service（存储进程）</h5> <ul><li>存储服务进程负责处理浏览器的存储相关任务，如文件读写，访问和管理本地存储、缓存等。</li> <li>它提供了一个统一的接口，用于管理各种类型的存储，包括本地文件系统、IndexedDB（本地数据库）等。</li></ul> <h5 id="audio-service-音频服务进程"><a href="#audio-service-音频服务进程" class="header-anchor">#</a> Audio Service（音频服务进程）</h5> <ul><li>音频服务进程处理浏览器中与音频相关的任务，包括音频播放、录制和通信。</li> <li>这个进程的存在有助于确保音频操作不会干扰到其他任务，同时提高了浏览器的稳定性和性能。</li></ul> <h5 id="tracing-service-追踪服务进程"><a href="#tracing-service-追踪服务进程" class="header-anchor">#</a> Tracing Service（追踪服务进程）</h5> <ul><li>追踪服务进程负责处理性能和调试追踪相关的任务，帮助开发人员分析浏览器的性能问题。</li> <li>它可以生成性能分析数据，用于识别瓶颈并优化浏览器的性能。</li></ul> <h4 id="渲染进程-renderer-process"><a href="#渲染进程-renderer-process" class="header-anchor">#</a> 渲染进程 (Renderer Process)</h4> <blockquote><p>Chrome默认会为每个Tab页面分配一个渲染进程，甚至会为每个Tab页面的<code>iframe标签</code>启动一个单独的渲染进程（开启了<code>站点隔离</code>的chrome版本）。<br>
浏览器有时会将多个渲染进程合并（譬如打开多个空白/崩溃/重启未加载的标签页后，会发现多个标签页被合并成了一个进程；或者运行在资源有限的设备上时，也会将同一站点服务聚合到一个进程中节省内存占用）。</p></blockquote> <p><img src="/assets/img/renderer-process.ac226c5a.png" alt="渲染进程"> 
渲染进程负责一个Tab内显示相关的工作，主要作用为页面渲染，脚本执行，事件处理等。其中包括多个线程：</p> <h5 id="主线程-worker-thread"><a href="#主线程-worker-thread" class="header-anchor">#</a> 主线程（Worker Thread）</h5> <ul><li>主线程是渲染进程的核心，负责解析HTML、CSS 和 JavaScript，构建DOM树和RenderObject树，布局和生成绘制列表等，并执行网页的渲染和交互。当界面需要重绘（Repaint）或由于某种操作引发回流(reflow)时，该线程就会执行。</li> <li>管理网页的布局和绘制，响应用户的输入事件，如鼠标点击和键盘输入。</li> <li>主线程也执行 JavaScript 代码，处理 DOM 操作和事件处理。</li></ul> <h5 id="工作线程-worker-thread"><a href="#工作线程-worker-thread" class="header-anchor">#</a> 工作线程（Worker Thread）</h5> <ul><li>工作线程允许在后台执行复杂的 JavaScript 代码，以避免主线程阻塞。</li> <li>它们可以进行计算密集型任务，而不影响主线程的响应性能。</li></ul> <p>可以将复杂的JavaScript计算逻辑放入<code>Web Worker</code>或<code>Service Worker</code>中，这时候就会用到Worker Thread进行处理。</p> <h5 id="栅格线程-raster-thread"><a href="#栅格线程-raster-thread" class="header-anchor">#</a> 栅格线程（Raster Thread）</h5> <p>也叫<code>Compositor Tile Worker</code>，可能有一个或多个线程，比如PC端的chrome是2个或4个，安卓和safari为1个或2个不等。是由合成线程创建的，专门用来处理<code>纹理(tile)</code>的<code>光栅化(Rasterization)</code>。</p> <h5 id="合成线程-compositor-thread"><a href="#合成线程-compositor-thread" class="header-anchor">#</a> 合成线程（Compositor Thread）</h5> <ul><li>负责接收浏览器传来的垂直同步信号(<code>Vsync</code>，水平同步表示画出一行屏幕线，垂直同步就表示从屏幕顶部到底部的绘制已经完成，指示着前一帧的结束，和新一帧的开始)。</li> <li>也负责接收OS传来的用户交互，比如滚动、输入、点击、鼠标移动等等：
<ul><li>如果可能，合成线程会直接负责处理这些输入，然后转换为对<code>layer图层</code>的位移和处理，生成若干个<code>图块(tile)</code>，栅格线程将图块转化成<code>位图(bitMap)</code>，然后合成线程收集接收到的<code>Draw Quads</code>信息并创建<code>合成帧(Compositor frame)</code>并将新的帧通过IPC管道commit到 <code>GPU进程(GPU Process)</code>，GPU生成一个大的纹理，最后draw到屏幕上；</li> <li>否则，比如你在滚动、输入事件等等上注册了回调，又或者当前页面中有动画等情况，那么这个时候合成线程便会唤醒<code>主线程(Main Thread)</code>，让后者去执行JS、完成重排、重绘等过程，更新<code>layer图层</code>，然后合成线程再进行上述步骤最终输出新的合成帧commit至<code>GPU Process</code>，完成输出。</li></ul></li></ul> <h4 id="gpu进程-gpu-process"><a href="#gpu进程-gpu-process" class="header-anchor">#</a> GPU进程 (GPU Process)</h4> <p>整个浏览器共用一个。负责处理和转发到GPU中的绘制命令（把渲染进程中绘制好的位图作为纹理上传至GPU，并调用GPU的相关方法把纹理合并渲染成一个位图，然后draw到屏幕上）。GPU进程工作于CPU中（而不是工作在GPU中），更应该称为“负责跟GPU打交道的进程”。GPU进程中只有一个<code>GPU线程</code>。</p> <h4 id="插件进程-plugin-process"><a href="#插件进程-plugin-process" class="header-anchor">#</a> 插件进程 (Plugin Process)</h4> <p>如果浏览器支持第三方插件（如 Adobe Flash Player），插件通常会在单独的插件进程中运行。这可以减少插件崩溃对浏览器整体的影响。
</p> <h3 id="多进程架构优势"><a href="#多进程架构优势" class="header-anchor">#</a> 多进程架构优势</h3> <h4 id="_1、容错性高-稳定性强"><a href="#_1、容错性高-稳定性强" class="header-anchor">#</a> 1、容错性高，稳定性强</h4> <p><img src="/assets/img/render-independent.1a2bbf53.png" alt="选项卡渲染进程独立"> 
Chrome 为每个选项卡分配自己的渲染进程。如果一个选项卡变得无响应，那么可以关闭无响应的选项卡，同时保持其他选项卡处于活动状态。如果所有选项卡都在一个进程上运行，则当一个选项卡无响应时，所有选项卡均无响应。</p> <p>在插件的实现中，html和js的规则是非常松散的，不管浏览器考虑的边界条件多完备，总是有各种奇怪的东西需要解析和兼容，随便一个小错误就会导致卡死或者崩溃，所以为每个插件对应启动一个新进程，插件的崩溃就只会影响到自身。</p> <h4 id="_2、安全性和沙箱机制-sandbox"><a href="#_2、安全性和沙箱机制-sandbox" class="header-anchor">#</a> 2、安全性和沙箱机制（Sandbox）</h4> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>渲染引擎会经常性的在网络上遇到不可信、甚至是恶意的代码，它们会利用这些漏洞在你的电脑上安装恶意的软件。如果有一种机制，<em><strong>将网页的运行限制在一个特定的环境中，也就是一个沙箱中，使它只能访问有限的功能。那么，即使网页工作的渲染引擎被攻击，它也不能够获取渲染引擎工作的主机系统中的任何权限，这一思想就是沙箱模型</strong></em>。</p> <p>操作系统层面的沙箱的含义就是：<red>操作系统对进程的可访问的内存地址所做的限制，限制进程可访问的内存在其被分配的内存地址区间内，而不允许操作其他的内存地址，从而提供安全层面的防护</red>。到浏览器层面，本质原理没多大变化，实践层面可能会根据浏览器环境有所变化，比如限制脚本操作本页面之外的其他页面的DOM，限制访问非同源文档，限制向非同源服务器发送ajax等等，目的依然是安全。</p></div> <p>把浏览器工作分成多个进程的另一好处是安全性与沙箱化。由于操作系统提供了限制进程权限的方法，因此浏览器可以对某些进程的某些功能进行沙箱处理，比如限制子进程（渲染进程、插件进程、GPU进程等）直接访问系统资源，限制子进程只能被某些或者很少的系统调用而且不能直接访问用户数据，这有助于保护用户免受不受信任和潜在恶意Web内容的攻击。</p> <p>chromium 的沙箱机制是将渲染进程作为防护对象，browser进程会给每个渲染进程分配资源，但这些渲染进程只能访问被分配的资源，不能访问未被分配的资源，网页代码如果要与浏览器内核进程通信、与操作系统通信都需要通过 <code>IPC channel</code>，在其中会进行一些安全检查。</p> <h4 id="_3、服务化特性-soa面向服务架构"><a href="#_3、服务化特性-soa面向服务架构" class="header-anchor">#</a> 3、服务化特性（SOA面向服务架构）</h4> <p>因为进程有自己的私有内存空间，它们通常会包含通用基础设施的副本（例如V8引擎）。这意味着更多的内存使用，因为它们不能像在同一进程中的线程那样共享数据。为了节省内存，Chrome 限制了浏览器可以启动的渲染进程数。限制取决于您的设备拥有多少内存和 CPU 能力，当 Chrome 达到限制时，它会开始在一个进程中运行来自同一站点的多个选项卡（所以这时，隔离性就会被影响）。
<img src="/assets/img/process-split.b023c03e.svg" alt="进程合成/拆分">
为了解决<code>资源占用</code>和<code>体系架构复杂</code>的问题，Chrome官方团队2016 年使用 <code>SOA</code> 思想设计了新的 Chrome 架构，当 Chrome 在强大的硬件上运行时，它会将每个服务拆分为不同的进程以提供更高的稳定性，服务之间直接通过IPC进行通信（IPC 允许不同进程在隔离的环境中协同工作，实现功能的分离和隔离）；但如果它在资源受限的设备上，Chrome 会将服务整合到单个浏览器进程中以节省内存占用。在这一架构变革实现前，Android 等平台上已经使用了类似的整合进程以减少内存使用的方案。</p> <h4 id="_4、站点隔离"><a href="#_4、站点隔离" class="header-anchor">#</a> 4、站点隔离</h4> <p><img src="/assets/img/site-isolate.58d4aefc.png" alt="站点隔离"> <strong>站点隔离</strong>是 Chrome 中最近引入的一项功能，它为每个<code>跨站点 iframe</code> 启动单独的渲染进程，并在不同站点之间共享内存空间，这从根本上扭转了iframe互相通信的形式。我们原先一直讨论每个选项卡一个渲染进程，假如在同一个渲染进程中运行 <code>a.com</code> 和 <code>b.com</code> 似乎没问题，但是为安全攻击带来了很多可能。</p> <p>大多数<a href="https://storage.googleapis.com/pub-tools-public-publication-data/pdf/f5a8289d4f69e9e34b38a1e7c05ef4818b22cd5b.pdf" target="_blank" rel="noopener noreferrer">UXSS攻击<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>都是通过绕过在渲染进程中实现的<a href="https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy" target="_blank" rel="noopener noreferrer">同源策略<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的存在检查来实现的（同源策略是网络的核心安全模型，它确保一个站点在未经同意的情况下无法访问其他站点的数据，绕过此策略是安全攻击的主要手段）。站点隔离通过隔离进程从根本上改变了这一点，也就是说，即使您可以绕过同源策略检查，其他站点的数据也无法在同一进程中使用。</p> <p>另外由于<a href="https://developer.chrome.com/blog/meltdown-spectre/" target="_blank" rel="noopener noreferrer">Meltdown和Spectre漏洞<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的存在（CPU内存管理技术设计漏洞），我们也需要使用进程隔离来分隔站点。自 Chrome 67 起，默认情况下在桌面上启用站点隔离，选项卡中的每个跨站点 iframe 都会获得一个单独的渲染进程。</p> <h2 id="参考文档"><a href="#参考文档" class="header-anchor">#</a> 参考文档</h2> <p><a href="https://blog.csdn.net/qq_40121580/article/details/107144304" target="_blank" rel="noopener noreferrer">CPU，缓存，内存，外存全解析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://developer.chrome.com/blog/inside-browser-part1" target="_blank" rel="noopener noreferrer">Inside look at modern web browser<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://www.4hou.com/shop/posts/9GQx" target="_blank" rel="noopener noreferrer">深度剖析站点隔离机制1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://www.4hou.com/posts/vRom" target="_blank" rel="noopener noreferrer">深度剖析站点隔离机制2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://www.4hou.com/index.php/posts/w2mR" target="_blank" rel="noopener noreferrer">深度剖析站点隔离机制3<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://book.douban.com/subject/25910556/" target="_blank" rel="noopener noreferrer">WebKit技术内幕<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://book.douban.com/subject/10546925/" target="_blank" rel="noopener noreferrer">白帽子讲Web安全<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/js/js-execute.html" class="prev">
        V8执行JavaScript原理
      </a></span> <span class="next"><a href="/blog/broswer/kernel.html">
        一文看懂浏览器内核
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9120daf7.js" defer></script><script src="/assets/js/2.a6e094ff.js" defer></script><script src="/assets/js/8.9f6f4f79.js" defer></script>
  </body>
</html>
