<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>浏览器兼容之bfcache | crise&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="./assets/logo.png">
    <meta name="description" content="一名程序员/前端人的技术博客">
    
    <link rel="preload" href="/assets/css/0.styles.567624d3.css" as="style"><link rel="preload" href="/assets/js/app.92dc81f6.js" as="script"><link rel="preload" href="/assets/js/2.2d54ebdc.js" as="script"><link rel="preload" href="/assets/js/34.b813165e.js" as="script"><link rel="prefetch" href="/assets/js/10.01084cac.js"><link rel="prefetch" href="/assets/js/11.bac0121f.js"><link rel="prefetch" href="/assets/js/12.4e876679.js"><link rel="prefetch" href="/assets/js/13.d3fce123.js"><link rel="prefetch" href="/assets/js/14.75510bd2.js"><link rel="prefetch" href="/assets/js/15.48750021.js"><link rel="prefetch" href="/assets/js/16.7952a809.js"><link rel="prefetch" href="/assets/js/17.10b72fbd.js"><link rel="prefetch" href="/assets/js/18.13c83f7d.js"><link rel="prefetch" href="/assets/js/19.31948ab8.js"><link rel="prefetch" href="/assets/js/20.dc4c0c1c.js"><link rel="prefetch" href="/assets/js/21.1b255fe0.js"><link rel="prefetch" href="/assets/js/22.2f1d66a8.js"><link rel="prefetch" href="/assets/js/23.cf0fa840.js"><link rel="prefetch" href="/assets/js/24.9cf68851.js"><link rel="prefetch" href="/assets/js/25.c501abdb.js"><link rel="prefetch" href="/assets/js/26.5f6dd563.js"><link rel="prefetch" href="/assets/js/27.74260c5a.js"><link rel="prefetch" href="/assets/js/28.ce8f13bc.js"><link rel="prefetch" href="/assets/js/29.06bdce57.js"><link rel="prefetch" href="/assets/js/3.e9d5348e.js"><link rel="prefetch" href="/assets/js/30.8204335f.js"><link rel="prefetch" href="/assets/js/31.01971e34.js"><link rel="prefetch" href="/assets/js/32.c9d7df95.js"><link rel="prefetch" href="/assets/js/33.96b6de7c.js"><link rel="prefetch" href="/assets/js/35.615aded7.js"><link rel="prefetch" href="/assets/js/36.9c619b20.js"><link rel="prefetch" href="/assets/js/37.90ffb782.js"><link rel="prefetch" href="/assets/js/38.1967fbbd.js"><link rel="prefetch" href="/assets/js/39.0d735efe.js"><link rel="prefetch" href="/assets/js/4.ca421095.js"><link rel="prefetch" href="/assets/js/40.923e5594.js"><link rel="prefetch" href="/assets/js/41.fd7797b4.js"><link rel="prefetch" href="/assets/js/42.7177cfca.js"><link rel="prefetch" href="/assets/js/43.b745c235.js"><link rel="prefetch" href="/assets/js/44.6fa2e561.js"><link rel="prefetch" href="/assets/js/45.9ecc0f19.js"><link rel="prefetch" href="/assets/js/46.d47edb5a.js"><link rel="prefetch" href="/assets/js/47.f48a72bc.js"><link rel="prefetch" href="/assets/js/48.19da9fb3.js"><link rel="prefetch" href="/assets/js/49.a5d16804.js"><link rel="prefetch" href="/assets/js/5.1898d05c.js"><link rel="prefetch" href="/assets/js/50.5efb3589.js"><link rel="prefetch" href="/assets/js/51.6a21aa98.js"><link rel="prefetch" href="/assets/js/52.2947ff47.js"><link rel="prefetch" href="/assets/js/53.dc63262e.js"><link rel="prefetch" href="/assets/js/54.fa9b8371.js"><link rel="prefetch" href="/assets/js/55.d0f31e05.js"><link rel="prefetch" href="/assets/js/56.de8ec14d.js"><link rel="prefetch" href="/assets/js/57.73331274.js"><link rel="prefetch" href="/assets/js/58.4f67425f.js"><link rel="prefetch" href="/assets/js/59.318ec5bd.js"><link rel="prefetch" href="/assets/js/6.c999d008.js"><link rel="prefetch" href="/assets/js/60.f6a602f9.js"><link rel="prefetch" href="/assets/js/61.c659faf6.js"><link rel="prefetch" href="/assets/js/62.4ccc91f2.js"><link rel="prefetch" href="/assets/js/63.6e5e36a9.js"><link rel="prefetch" href="/assets/js/64.2660e08e.js"><link rel="prefetch" href="/assets/js/65.b06b0bed.js"><link rel="prefetch" href="/assets/js/66.1f836a7a.js"><link rel="prefetch" href="/assets/js/67.add88f29.js"><link rel="prefetch" href="/assets/js/68.e74a51fc.js"><link rel="prefetch" href="/assets/js/69.63126800.js"><link rel="prefetch" href="/assets/js/7.92efcfae.js"><link rel="prefetch" href="/assets/js/70.1dc8f877.js"><link rel="prefetch" href="/assets/js/71.856f3fe1.js"><link rel="prefetch" href="/assets/js/72.927e4ce2.js"><link rel="prefetch" href="/assets/js/73.2c1e909e.js"><link rel="prefetch" href="/assets/js/74.c8b565d2.js"><link rel="prefetch" href="/assets/js/75.00537c0a.js"><link rel="prefetch" href="/assets/js/76.492fbce1.js"><link rel="prefetch" href="/assets/js/77.6fb48b9b.js"><link rel="prefetch" href="/assets/js/78.d5aea725.js"><link rel="prefetch" href="/assets/js/8.81eb0648.js"><link rel="prefetch" href="/assets/js/9.1bebc5a8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.567624d3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">crise's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法题库
</a></div><div class="nav-item"><a href="https://baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微博
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法题库
</a></div><div class="nav-item"><a href="https://baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微博
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>js进阶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>浏览器</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/broswer/broswer-framework.html" class="sidebar-link">一文搞定浏览器架构</a></li><li><a href="/blog/broswer/kernel.html" class="sidebar-link">一文看懂浏览器内核</a></li><li><a href="/blog/broswer/useragent.html" class="sidebar-link">浏览器和UserAgent发展史</a></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>原理篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/broswer/website-navigation.html" class="sidebar-link">从浏览器输入网址到页面加载，中间发生了什么？</a></li><li><a href="/blog/broswer/render-mechanism.html" class="sidebar-link">浏览器渲染原理</a></li><li><a href="/blog/broswer/compositor-layer-manage.html" class="sidebar-link">合成层详解</a></li><li><a href="/blog/broswer/reflow-repaint-composite.html" class="sidebar-link">重排、重绘与合成</a></li><li><a href="/blog/broswer/js-mechanism.html" class="sidebar-link">JS执行机制</a></li><li><a href="/blog/broswer/v8-execute.html" class="sidebar-link">V8执行JavaScript原理</a></li><li><a href="/blog/broswer/http-cache.html" class="sidebar-link">浏览器缓存机制</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>兼容篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/broswer/bfcache.html" aria-current="page" class="active sidebar-link">浏览器兼容之bfcache</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/broswer/bfcache.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/blog/broswer/bfcache.html#分析" class="sidebar-link">分析</a></li><li class="sidebar-sub-header"><a href="/blog/broswer/bfcache.html#bfcache-探秘" class="sidebar-link">bfcache 探秘</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/broswer/bfcache.html#定义" class="sidebar-link">定义</a></li><li class="sidebar-sub-header"><a href="/blog/broswer/bfcache.html#浏览器差异" class="sidebar-link">浏览器差异</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/broswer/bfcache.html#解决方案" class="sidebar-link">解决方案：</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/broswer/bfcache.html#_1、disable-bfcache-未做过测试" class="sidebar-link">1、disable bfcache（未做过测试）</a></li><li class="sidebar-sub-header"><a href="/blog/broswer/bfcache.html#_2、利用pageshow事件-推荐" class="sidebar-link">2、利用pageshow事件（推荐）</a></li><li class="sidebar-sub-header"><a href="/blog/broswer/bfcache.html#_3、js监听pagehiden事件阻止页面进入bfcache" class="sidebar-link">3、js监听pagehiden事件阻止页面进入bfcache</a></li><li class="sidebar-sub-header"><a href="/blog/broswer/bfcache.html#_4、设置meta标签-清除页面缓存" class="sidebar-link">4、设置meta标签，清除页面缓存</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/broswer/bfcache.html#参考文档" class="sidebar-link">参考文档</a></li></ul></li><li><a href="/blog/broswer/compatibility.html" class="sidebar-link">浏览器兼容性问题研究</a></li><li><a href="/blog/broswer/pageshow-visibilitychange.html" class="sidebar-link">pageshow、pagehide、visibilitychange对比</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端工程化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>web跨端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>框架与原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机与网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>运维与安全</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="浏览器兼容之bfcache"><a href="#浏览器兼容之bfcache" class="header-anchor">#</a> 浏览器兼容之bfcache</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>移动端浏览器开发，常常会遇到<code>bfcache</code>的问题。举个🌰：
假设有A，B两个页面</p> <div class="language- extra-class"><pre class="language-text"><code>A：商品列表页
B：商品收藏页
</code></pre></div><p>在A页面中调用接口收藏商品C，收藏完成，点击收藏按钮前往B页面查看收藏列表；在B页面取消商品C的收藏，然后点击浏览器<code>后退</code>按钮/页面返回按钮，返回到A页面，这时候会发现商品C依然是收藏状态。</p> <h2 id="分析"><a href="#分析" class="header-anchor">#</a> 分析</h2> <p>通过抓包工具或者<code>vconsole</code>查看，会发现页面A根本没有重新调用接口，通过调试发现，返回到页面A时不会重新执行页面<code>onload</code>逻辑（<code>vue</code>中为<code>onMounted</code>,<code>react</code>中为<code>componentDidMount</code>事件），经过google发现，这是<code>webkit</code>内核根据<code>Firefox的1.5</code>的一个新功能<code>bfcache</code>，做的一个浏览器页面访问的自身优化。</p> <p>所以，由于某些浏览器<code>bf-cache</code>的存在，我们在测试时发现，我们的代码块根本就没有执行。既然bug产生了，我们该如何去解决它？</p> <p>测试得到的事实：
这个<code>issue</code>在<code>andriod</code>和<code>ios</code>中各个浏览器的表现并不一致，并不是每一次的返回都会从缓存中读取数据。既然bug产生了，我们该如何去解决它？</p> <h2 id="bfcache-探秘"><a href="#bfcache-探秘" class="header-anchor">#</a> bfcache 探秘</h2> <h3 id="定义"><a href="#定义" class="header-anchor">#</a> 定义</h3> <p><a href="https://developer.mozilla.org/en-US/docs/Mozilla/Firefox/Releases/1.5/Using_Firefox_1.5_caching" target="_blank" rel="noopener noreferrer">bf-cache<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，即<code>back-forward cache</code>，可称“往返缓存”，可以在用户使用浏览器的“后退”和“前进”按钮时加快页面的转换速度。这个缓存不仅保存页面数据，还保存了<code>DOM</code>和<code>JS</code>的状态，实际上是将整个页面都保存在内存中，如果页面位于<code>bfcache</code>中，那么再次打开页面就不会触发<code>onload</code>事件。</p> <p>我理解<code>bfcache</code>就是类似于“快照”的技术。浏览器解析 HTML、CSS、JS等各类媒体资源后，会把这一个结果暂存起来。用户返回的时候，浏览器可以不用重新解析 HTML、CSS、JS等等，直接将这个“快照”拿出来就可以了。这样在移动端能节省大量的资源。在交互体验上也有很大的优势。比如说在渲染懒加载的长列表的时候，返回到上一页，所有之前请求到的接口数据、DOM 节点都不会被销毁。用户点击进入长列表的某一项查看详情，点击返回的时候能够立即继续查看。这一点采用<code>SPA</code>方案的话，<code>vue</code>得使用<a href="https://v3.cn.vuejs.org/api/built-in-components.html#keep-alive" target="_blank" rel="noopener noreferrer">keep-alive<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，<code>react</code>目前还做不到这一点，但已经有了提案<a href="https://github.com/facebook/react/issues/13206" target="_blank" rel="noopener noreferrer">offscreen API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="浏览器差异"><a href="#浏览器差异" class="header-anchor">#</a> 浏览器差异</h3> <p><code>chrome</code> 在 <code>Android</code> 系统上现在 用的是 <code>blink</code> 内核，根据相关资料[1]显示，在很久以前就已经将<code>PageCache</code>（即<code>bfcache</code>）这部分代码移除了，也就是说现在的chrome应该是没有这个东西的。可以确定的是，<code>chrome</code>以前的版本中，<code>bfcache</code>的实现是从<code>webkit</code>中拿来的，由于移动端项目目前面向的用户主体就是 iOS + Android，iOS下是基于<code>Webkit</code>，<code>Android</code>基于<code>chrome</code>（且这部分功能也是源于webkit）。因此追溯这个问题，我们只要专注于研究<code>webkit</code>里<code>bfcache</code>的逻辑即可。</p> <h2 id="解决方案"><a href="#解决方案" class="header-anchor">#</a> 解决方案：</h2> <h3 id="_1、disable-bfcache-未做过测试"><a href="#_1、disable-bfcache-未做过测试" class="header-anchor">#</a> 1、disable bfcache（未做过测试）</h3> <p>业务上添加如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> bfWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'unload'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里绑个事件，构造一个闭包，以免 worker 被垃圾回收导致逻辑失效</span>
        bfWorker<span class="token punctuation">.</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// if you want to do something here.</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2、利用pageshow事件-推荐"><a href="#_2、利用pageshow事件-推荐" class="header-anchor">#</a> 2、利用<code>pageshow</code>事件（推荐）</h3> <p>个人认为最合理的解决方式其实是监听<code>pageshow</code>事件，目前<a href="https://caniuse.com/?search=pageshow" target="_blank" rel="noopener noreferrer">兼容性<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>达到了97%以上。这个事件在页面显示时触发，无论页面是否来自<code>bfcache</code>。在重新加载页面中，<code>pageshow</code>会在<code>load</code>事件触发后触发；而对于<code>bfcache</code>中的页面，<code>pageshow</code>会在页面状态完全恢复的那一刻触发。
当页面加载<code>bfcache</code>时<code>onload</code>事件不会被触发。相反，可以检查<code>onpageshow</code>事件的持久性属性值<code>persisted</code>。对于<code>pageshow</code>事件，初始页面加载时<code>persisted</code>值为<code>false</code>；如果页面是从<code>bfcache</code>中加载的，那么<code>persisted</code>的值就是<code>true</code>。</p> <p>解决思路：
页面在点击回退按钮时，会触发pageshow事件，如果这个页面是从缓存加载的，那么persisted的值为true，此时调用reload，强制刷新，可以阻止页面进入bfcache。或者重新调用一次收藏接口。
业务上添加如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'pageshow'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>persisted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// reload，这时候会发现页面展现之后会再有一个重新加载的过程，对用户不是太友好</span>
      window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 重新调用接口/其他逻辑</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_3、js监听pagehiden事件阻止页面进入bfcache"><a href="#_3、js监听pagehiden事件阻止页面进入bfcache" class="header-anchor">#</a> 3、js监听pagehiden事件阻止页面进入bfcache</h3> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'pagehide'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>persisted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> dom <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    dom<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      dom<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;script type='text/javascript'&gt;window.location.reload();&lt;/script&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_4、设置meta标签-清除页面缓存"><a href="#_4、设置meta标签-清除页面缓存" class="header-anchor">#</a> 4、设置meta标签，清除页面缓存</h3> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Cache-Control<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>no-cache, no-store, must-revalidate<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Pragma<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>no-cache<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Expires<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre></div><p><code>Cache-Control</code>指定请求和响应遵循的缓存机制。在请求消息或响应消息中设置<code>Cache-Control</code>并不会修改另一个消息处理过程中的缓存处理过程。</p> <ul><li>no-cache：指示请求或响应消息不能使用强缓存</li> <li>no-store：用于防止重要的信息被无意的发布。在请求消息中发送将使得请求和响应消息都不使用缓存。</li> <li>must-revalidate：告诉浏览器、缓存服务器，本地副本过期前，可以使用本地副本；本地副本一旦过期，必须去源服务器进行有效性校验。</li></ul> <h2 id="参考文档"><a href="#参考文档" class="header-anchor">#</a> 参考文档</h2> <p><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=229605" target="_blank" rel="noopener noreferrer">chromium issues<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://github.com/WebKit/webkit/blob/0fce2cb9b2fd61f9f249f09a14b40ac163ab16c6/Source/WebCore/history/PageCache.cpp" target="_blank" rel="noopener noreferrer">Webkit中bfcache相关逻辑<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://github.com/LeuisKen/leuisken.github.io/issues/6" target="_blank" rel="noopener noreferrer">浏览器往返缓存（Back/Forward cache）问题的分析与解决<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://developers.google.com/web/updates/2019/02/back-forward-cache" target="_blank" rel="noopener noreferrer">back-forward-cache<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://back-forward-cache-tester.glitch.me" target="_blank" rel="noopener noreferrer">BFCache测试地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://webkit.org/blog/516/webkit-page-cache-ii-the-unload-event/" target="_blank" rel="noopener noreferrer">webkit page cache<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/broswer/http-cache.html" class="prev">
        浏览器缓存机制
      </a></span> <span class="next"><a href="/blog/broswer/compatibility.html">
        浏览器兼容性问题研究
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.92dc81f6.js" defer></script><script src="/assets/js/2.2d54ebdc.js" defer></script><script src="/assets/js/34.b813165e.js" defer></script>
  </body>
</html>
