<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>js精度丢失问题深度解析 | crise&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="./assets/logo.png">
    <meta name="description" content="一名程序员/前端人的技术博客">
    
    <link rel="preload" href="/assets/css/0.styles.567624d3.css" as="style"><link rel="preload" href="/assets/js/app.92dc81f6.js" as="script"><link rel="preload" href="/assets/js/2.2d54ebdc.js" as="script"><link rel="preload" href="/assets/js/6.c999d008.js" as="script"><link rel="prefetch" href="/assets/js/10.01084cac.js"><link rel="prefetch" href="/assets/js/11.bac0121f.js"><link rel="prefetch" href="/assets/js/12.4e876679.js"><link rel="prefetch" href="/assets/js/13.d3fce123.js"><link rel="prefetch" href="/assets/js/14.75510bd2.js"><link rel="prefetch" href="/assets/js/15.48750021.js"><link rel="prefetch" href="/assets/js/16.7952a809.js"><link rel="prefetch" href="/assets/js/17.10b72fbd.js"><link rel="prefetch" href="/assets/js/18.13c83f7d.js"><link rel="prefetch" href="/assets/js/19.31948ab8.js"><link rel="prefetch" href="/assets/js/20.dc4c0c1c.js"><link rel="prefetch" href="/assets/js/21.1b255fe0.js"><link rel="prefetch" href="/assets/js/22.2f1d66a8.js"><link rel="prefetch" href="/assets/js/23.cf0fa840.js"><link rel="prefetch" href="/assets/js/24.9cf68851.js"><link rel="prefetch" href="/assets/js/25.c501abdb.js"><link rel="prefetch" href="/assets/js/26.5f6dd563.js"><link rel="prefetch" href="/assets/js/27.74260c5a.js"><link rel="prefetch" href="/assets/js/28.ce8f13bc.js"><link rel="prefetch" href="/assets/js/29.06bdce57.js"><link rel="prefetch" href="/assets/js/3.e9d5348e.js"><link rel="prefetch" href="/assets/js/30.8204335f.js"><link rel="prefetch" href="/assets/js/31.01971e34.js"><link rel="prefetch" href="/assets/js/32.c9d7df95.js"><link rel="prefetch" href="/assets/js/33.96b6de7c.js"><link rel="prefetch" href="/assets/js/34.b813165e.js"><link rel="prefetch" href="/assets/js/35.615aded7.js"><link rel="prefetch" href="/assets/js/36.9c619b20.js"><link rel="prefetch" href="/assets/js/37.90ffb782.js"><link rel="prefetch" href="/assets/js/38.1967fbbd.js"><link rel="prefetch" href="/assets/js/39.0d735efe.js"><link rel="prefetch" href="/assets/js/4.ca421095.js"><link rel="prefetch" href="/assets/js/40.923e5594.js"><link rel="prefetch" href="/assets/js/41.fd7797b4.js"><link rel="prefetch" href="/assets/js/42.7177cfca.js"><link rel="prefetch" href="/assets/js/43.b745c235.js"><link rel="prefetch" href="/assets/js/44.6fa2e561.js"><link rel="prefetch" href="/assets/js/45.9ecc0f19.js"><link rel="prefetch" href="/assets/js/46.d47edb5a.js"><link rel="prefetch" href="/assets/js/47.f48a72bc.js"><link rel="prefetch" href="/assets/js/48.19da9fb3.js"><link rel="prefetch" href="/assets/js/49.a5d16804.js"><link rel="prefetch" href="/assets/js/5.1898d05c.js"><link rel="prefetch" href="/assets/js/50.5efb3589.js"><link rel="prefetch" href="/assets/js/51.6a21aa98.js"><link rel="prefetch" href="/assets/js/52.2947ff47.js"><link rel="prefetch" href="/assets/js/53.dc63262e.js"><link rel="prefetch" href="/assets/js/54.fa9b8371.js"><link rel="prefetch" href="/assets/js/55.d0f31e05.js"><link rel="prefetch" href="/assets/js/56.de8ec14d.js"><link rel="prefetch" href="/assets/js/57.73331274.js"><link rel="prefetch" href="/assets/js/58.4f67425f.js"><link rel="prefetch" href="/assets/js/59.318ec5bd.js"><link rel="prefetch" href="/assets/js/60.f6a602f9.js"><link rel="prefetch" href="/assets/js/61.c659faf6.js"><link rel="prefetch" href="/assets/js/62.4ccc91f2.js"><link rel="prefetch" href="/assets/js/63.6e5e36a9.js"><link rel="prefetch" href="/assets/js/64.2660e08e.js"><link rel="prefetch" href="/assets/js/65.b06b0bed.js"><link rel="prefetch" href="/assets/js/66.1f836a7a.js"><link rel="prefetch" href="/assets/js/67.add88f29.js"><link rel="prefetch" href="/assets/js/68.e74a51fc.js"><link rel="prefetch" href="/assets/js/69.63126800.js"><link rel="prefetch" href="/assets/js/7.92efcfae.js"><link rel="prefetch" href="/assets/js/70.1dc8f877.js"><link rel="prefetch" href="/assets/js/71.856f3fe1.js"><link rel="prefetch" href="/assets/js/72.927e4ce2.js"><link rel="prefetch" href="/assets/js/73.2c1e909e.js"><link rel="prefetch" href="/assets/js/74.c8b565d2.js"><link rel="prefetch" href="/assets/js/75.00537c0a.js"><link rel="prefetch" href="/assets/js/76.492fbce1.js"><link rel="prefetch" href="/assets/js/77.6fb48b9b.js"><link rel="prefetch" href="/assets/js/78.d5aea725.js"><link rel="prefetch" href="/assets/js/8.81eb0648.js"><link rel="prefetch" href="/assets/js/9.1bebc5a8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.567624d3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">crise's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法题库
</a></div><div class="nav-item"><a href="https://baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微博
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法题库
</a></div><div class="nav-item"><a href="https://baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微博
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>js进阶</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/js/multi-thread.html" class="sidebar-link">JS中的多线程编程</a></li><li><a href="/blog/js/precision.html" aria-current="page" class="active sidebar-link">js精度丢失问题深度解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/js/precision.html#背景" class="sidebar-link">背景</a></li><li class="sidebar-sub-header"><a href="/blog/js/precision.html#浮点数存储原理" class="sidebar-link">浮点数存储原理</a></li><li class="sidebar-sub-header"><a href="/blog/js/precision.html#数字超限导致精度丢失" class="sidebar-link">数字超限导致精度丢失</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/js/precision.html#number最大值计算" class="sidebar-link">Number最大值计算</a></li><li class="sidebar-sub-header"><a href="/blog/js/precision.html#number最大安全整数计算" class="sidebar-link">Number最大安全整数计算</a></li><li class="sidebar-sub-header"><a href="/blog/js/precision.html#解决方案" class="sidebar-link">解决方案</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/js/precision.html#舍入误差导致精度丢失" class="sidebar-link">舍入误差导致精度丢失</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/js/precision.html#舍入误差" class="sidebar-link">舍入误差</a></li><li class="sidebar-sub-header"><a href="/blog/js/precision.html#为什么-0-1-0-2-0-3" class="sidebar-link">为什么 0.1 + 0.2 ！== 0.3？</a></li><li class="sidebar-sub-header"><a href="/blog/js/precision.html#解决方案-2" class="sidebar-link">解决方案</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/js/precision.html#参考文档" class="sidebar-link">参考文档</a></li></ul></li><li><a href="/blog/js/this.html" class="sidebar-link">一文搞定this指向性问题</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端工程化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>web跨端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>框架与原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机与网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>运维与安全</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="js精度丢失问题深度解析"><a href="#js精度丢失问题深度解析" class="header-anchor">#</a> js精度丢失问题深度解析</h1> <h2 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h2> <p>我们在做项目的过程中，涉及到订单号或者价格计算的时候，经常会出现<code>js精度丢失</code>的问题。比如：</p> <ul><li>后端在主接口给你返回一个Long类型的订单号（假设18位），然后你获取到订单号，再拿订单号去请求别的接口，然后发现这个接口返回数据有问题，然后开始和后端一顿拉扯，最后发现是后端返回给你的订单号和你给后端传参的订单号不一致；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 18位</span>
<span class="token number">202311271723152070</span> <span class="token comment">// 202311271723152060</span>
<span class="token comment">// 17位</span>
<span class="token number">20231127172315207</span> <span class="token comment">// 20231127172315210</span>
</code></pre></div><ul><li>我们在计算商品价格的时候，涉及到小数的加减乘除，常常会出现前端计算出来的价格和用户要支付的金额不相等的情况；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 加法</span>
<span class="token number">0.1</span> <span class="token operator">+</span> <span class="token number">0.2</span> <span class="token operator">=</span> <span class="token number">0.30000000000000004</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token operator">+</span> c <span class="token operator">===</span> a <span class="token operator">+</span> <span class="token punctuation">(</span> b <span class="token operator">+</span> c <span class="token punctuation">)</span> <span class="token comment">// false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">)</span>
<span class="token comment">// 减法</span>
<span class="token number">1.5</span> <span class="token operator">-</span> <span class="token number">1.2</span> <span class="token operator">=</span> <span class="token number">0.30000000000000004</span>
<span class="token number">0.3</span> <span class="token operator">-</span> <span class="token number">0.2</span> <span class="token operator">=</span> <span class="token number">0.09999999999999998</span>
<span class="token comment">// 乘法</span>
<span class="token number">19.9</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">=</span> <span class="token number">1989.9999999999998</span>
<span class="token number">0.8</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">=</span> <span class="token number">2.4000000000000004</span>
<span class="token comment">// 除法</span>
<span class="token number">0.3</span> <span class="token operator">/</span> <span class="token number">0.1</span> <span class="token operator">=</span> <span class="token number">2.9999999999999996</span>
<span class="token number">0.69</span> <span class="token operator">/</span> <span class="token number">10</span> <span class="token operator">=</span> <span class="token number">0.06899999999999999</span>
</code></pre></div><p>下面我们来探讨下出现以上问题的具体原因和解决方案。</p> <h2 id="浮点数存储原理"><a href="#浮点数存储原理" class="header-anchor">#</a> 浮点数存储原理</h2> <div class="custom-block tip"><p class="custom-block-title">IEEE 754 标准</p> <p>IEEE二进制浮点数算术标准<a href="https://zh.wikipedia.org/wiki/IEEE_754" target="_blank" rel="noopener noreferrer">IEEE 754<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是20世纪80年代以来最广泛使用的浮点数运算标准。</p> <p>IEEE 754规定了四种表示浮点数值的方式：<code>单精确度（32位）</code>、<code>双精确度（64位）</code>、<code>延伸单精确度</code>（43比特以上，很少使用）与<code>延伸双精确度</code>（79比特以上，通常以80位实现）。</p></div> <p>和其它语言如Java和Python不同，JavaScript中所有数字包括整数和小数都只有一种类型 — <code>Number</code>。它的实现遵循 IEEE 754 标准，使用64位固定长度来表示，也就是标准的 <code>double 双精度浮点数</code>。</p> <p>这样的存储结构优点是可以归一化处理整数和小数，节省存储空间。
<img src="/assets/img/double-float.78ff00fa.jpg" alt="double 双精度浮点数"></p> <ul><li>符号位S：第 1 位是正负数符号位（sign），0代表正数，1代表负数</li> <li>指数位E：中间的 11 位存储指数（exponent），<em><strong>指数按照补位运算，即直接 1023（偏移值） 加指数位</strong></em>（由于指数位的 11 位不包括符号位，那么为了达到正负指数的效果，就引入了指数的偏移值）</li> <li>尾数位M：最后的 52 位是小数点后的尾数（mantissa），<em><strong>超出52位的部分自动舍0进1</strong></em></li></ul> <p>举个🌰，假如我们将 <red>106.6953125</red> 转换为二进制数按规则放进内存中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token number">106.6953125</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 1101010.1011001</span>
</code></pre></div><p>首先 <code>106.6953125</code> 是正数，所以内存中符号位为0, 0表示正，1表示负
<img src="/assets/img/double-float-1.0cc83f73.jpg" alt="double 双精度浮点数"> <red>1101010.1011001</red> 用<a href="https://zh.wikipedia.org/wiki/%E7%A7%91%E5%AD%A6%E8%AE%B0%E6%95%B0%E6%B3%95" target="_blank" rel="noopener noreferrer">科学计数法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>表示为 =&gt; <red>1.1010101011001 * 2^6</red>，然后我们计算指数位：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1.1010101011001 * 2^6</span>
<span class="token comment">// 指数6 + 偏移量1023 = 1029</span>
<span class="token number">1029.</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 10000000101</span>
</code></pre></div><p>而指数位要求放补码。正数的补码是其原码本身不变（规则参考<a href="/blog/computer/binary.html#补码">补码计算规则</a>），所以将 10000000101 填入指数位。
<img src="/assets/img/double-float-2.f2c66001.jpg" alt="double 双精度浮点数">
尾数位部分直接将小数转换后的二进制 1010101011001 填入，不足52位的补0即可。</p> <p>可能有个疑问：小数点前面的1去哪里了？由于尾数部分是规格化表示的，最高位总是“1”，所以直接隐藏掉，同时也节省了1个位出来存储小数，提高精度。</p> <h2 id="数字超限导致精度丢失"><a href="#数字超限导致精度丢失" class="header-anchor">#</a> 数字超限导致精度丢失</h2> <p>IEEE 754标准规定，最大安全整数：<code>Number.MAX_SAFE_INTEGER</code> =&gt; 9007199254740991（即2^53-1）。当js的数值超过这个最大安全整数，就会存在精度丢失问题，也就会出现文章开头第一种类型问题以及其他怪异现象。</p> <h3 id="number最大值计算"><a href="#number最大值计算" class="header-anchor">#</a> Number最大值计算</h3> <p>根据浮点数存储原理一节，我们可以知道，js中我们能够表达、枚举和存储的最大数为 <red>Number.MAX_VALUE</red>，它的计算规则为：</p> <p><em><strong>指数部分最大的数 ✖️ 尾数部分最大的数</strong></em></p> <p><img src="/assets/img/double-float-max.cf453cde.jpg" alt="double 双精度浮点数"></p> <ul><li>指数部分最大的数：2^10 −1 = 1023</li> <li>尾数最大部分为 1(隐藏位).(52个1)，为 <red>11111111111111111111111111111111111111111111111111111</red>，即 2^53 − 1</li></ul> <p>所以最大数的二进制表示为：<red>1.11111111111111111111111111111111111111111111111111111 * 2^1023</red>，转换成十进制，最大值则为：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 尾数最大部分为 1(隐藏位).(52个1)，在二进制将小数点移到最右侧，需要将指数部分减去52位：</span>
<span class="token number">1.11111111111111111111111111111111111111111111111111111</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token operator">^</span><span class="token number">1023</span>
<span class="token operator">=</span> <span class="token number">111111111111111111111111111111111111111111111111111111</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token operator">^</span><span class="token punctuation">(</span><span class="token number">1023</span><span class="token operator">-</span><span class="token number">52</span><span class="token punctuation">)</span>
<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">^</span><span class="token punctuation">(</span><span class="token number">53</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token operator">^</span><span class="token number">971</span>
<span class="token operator">=</span> <span class="token number">1.7976931348623157e+308</span>
</code></pre></div><p>实际上，这正是Number能够表达、枚举和存储的最大值了，Number用了一个常量来表示，超过这个数就会使用Infinity来表示。</p> <div class="language-js extra-class"><pre class="language-js"><code>Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>  <span class="token comment">// Infinity</span>
</code></pre></div><h3 id="number最大安全整数计算"><a href="#number最大安全整数计算" class="header-anchor">#</a> Number最大安全整数计算</h3> <p>上面只是Number有能力表示的最大数，但是和精度表示还是两码事。至于为什么不能用Number最大值来表示Number的最大安全整数呢？实际是因为指数表示并不能表示连续的数字。</p> <p>实际上一旦超过某个范围，js就不能够精确表示某个数了，只能用近似的数去表示，所以你可以看到这样的奇怪现象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token number">9007199254740993</span> <span class="token operator">===</span> <span class="token number">9007199254740992</span> <span class="token comment">// true</span>
</code></pre></div><p>在计算Number最大值中我们学过，<strong>科学计数法能够均匀枚举的整数范围就是尾数最大值</strong>，所以我们很容易得出，安全的整数范围就是：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token number">111111111111111111111111111111111111111111111111111111</span>
<span class="token operator">=</span> <span class="token number">2</span><span class="token operator">^</span><span class="token punctuation">(</span><span class="token number">53</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token operator">=</span> <span class="token number">9007199254740991</span>
</code></pre></div><p>因为有53位（加上隐藏位）所以能够枚举和表达出的每一个[0,9007199254740991]之间的整数，超过这个范围就不行了，所以才会出现<red>9007199254740993 === 9007199254740992</red>这种怪异现象。</p> <h3 id="解决方案"><a href="#解决方案" class="header-anchor">#</a> 解决方案</h3> <p>js Number的最大安全整数为16位，所以超过16的数字最好使用string类型存储。</p> <h2 id="舍入误差导致精度丢失"><a href="#舍入误差导致精度丢失" class="header-anchor">#</a> 舍入误差导致精度丢失</h2> <h3 id="舍入误差"><a href="#舍入误差" class="header-anchor">#</a> 舍入误差</h3> <p>有了上面对浮点数进行介绍，现在我们进入了一个更棘手的问题–舍入误差。它是所有开发者使用浮点数开发的祸根，JavaScript开发者尤其如此，因为JavaScript开发者唯一可用的编号格式是浮点数。</p> <p>上面提到的分数⅓不能在以10为底中有限表示。这实际上在任何数制中都存在。例如，在在以二为底的数字中，1 / 10不能有限表示。被表示为0.00110011001100110011……注意0011是无限重复的。这是因为这个特别的怪癖，舍入误差造成的。</p> <p>先看一个舍入误差的例子。考虑一个最著名的无理数，PI：3.141592653589793……大多数人记得前五位（3.1415）非常棒——我们将使用这个例子说明舍入误差，因此可以计算舍入误差：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 其中`R`代表圆形的半径，`A`代表一个实数。`Bp`代表以`p`为底的精度。所以PI的舍入误差：0.00009265……</span>
<span class="token punctuation">(</span><span class="token constant">R</span> <span class="token operator">-</span> <span class="token constant">A</span><span class="token punctuation">)</span> <span class="token operator">/</span> Bp<span class="token operator">-</span><span class="token number">1</span>
</code></pre></div><p>虽然这看起似乎不是很严重，让我们试着用以二为底的数来检验这个想法。</p> <p>比如 <strong>分数1/10</strong>，在十进制，它被写作 <strong>0.1</strong>。在二进制中，它是：<strong>0.00011001100110011……</strong> 假设我们仅保留5位尾数，可以写为<strong>0.0001</strong>。但0.0001在二进制表示法中实际是**1 / 16（或0.0625）**的表示！这意味着有<red>舍入误差为0.0375</red>，这是相当大的。<em><strong>想象一下基本的加法运算，如0.1 + 0.2，答案返回0.2625</strong></em>！</p> <p>幸运的是，浮点规范指定ECMAScript最多使用52个尾数，所以舍入误差变得很小——规范的具体细节规避了大部分的舍入误差。因为对浮点数进行算术运算的过程中误差会被放大，IEEE 754规范还包括用于数学运算的具体算法。</p> <h3 id="为什么-0-1-0-2-0-3"><a href="#为什么-0-1-0-2-0-3" class="header-anchor">#</a> 为什么 0.1 + 0.2 ！== 0.3？</h3> <p>其实，了解了浮点数储存原理和舍入误差，我们应该大致明白为什么会丢失精度了，接下来我们以 <code>0.1 + 0.2 ！== 0.3</code> 为例，一步步分析下丢失的过程。</p> <h4 id="第一步-转换为二进制"><a href="#第一步-转换为二进制" class="header-anchor">#</a> 第一步：转换为二进制</h4> <p>整数和小数转二进制方法，可以点击 <a href="/blog/computer/binary.html#十进制转二进制">十进制转二进制</a> 查看</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token number">0.1</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 0.0001100110011001100110011001100110011001100110011001101</span>
<span class="token number">0.2</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 0.001100110011001100110011001100110011001100110011001101</span>
<span class="token number">0.3</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 0.010011001100110011001100110011001100110011001100110011</span>
</code></pre></div><p>统一用科学计数法表示为：
<img src="/assets/img/rounding-error.4292e697.png" alt="0.1、0.2、0.3转二进制"></p> <h4 id="第二步-存储"><a href="#第二步-存储" class="header-anchor">#</a> 第二步：存储</h4> <p>放入计算机中双精度浮点数存储，指数部分计算为 <em><strong>指数+偏移量1023</strong></em>，最后的红色表示超过尾数位的二进制，即需要做舍0进1处理（截断时舍0进1，所以就产生了误差，一步差步步差，这就是精度丢失的本质）
<img src="/assets/img/double-float-4.86a6da5d.jpg" alt="0.1、0.2、0.3存储">
最终64位双精度存储的二进制位如下表示：
<img src="data:image/png;base64,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" alt="0.1、0.2、0.3存储"></p> <h4 id="第三步-计算"><a href="#第三步-计算" class="header-anchor">#</a> 第三步：计算</h4> <p><img src="/assets/img/rounding-error-3.07e69e43.jpg" alt="0.1、0.2、0.3存储">
此时可以看出 <red>0.1 + 0.2 !== 0.3</red></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 0.1 + 0.2 === 0.30000000000000004</span>
<span class="token number">1.0011001100110011001100110011001100110011001100110100</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token operator">^</span><span class="token operator">-</span><span class="token number">2</span> <span class="token operator">=&gt;</span>
<span class="token number">0.010011001100110011001100110011001100110011001100110100</span> <span class="token operator">=&gt;</span>
<span class="token number">0.30000000000000004</span>
</code></pre></div><h3 id="解决方案-2"><a href="#解决方案-2" class="header-anchor">#</a> 解决方案</h3> <h4 id="tofixed"><a href="#tofixed" class="header-anchor">#</a> toFixed</h4> <p>在遇到浮点数运算后出现的精度问题时，如果需求仅仅只是保留2位小数，显示价格的话，刚开始我是想用toFixed(2)来解决的。因为<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Number/toFixed#%E6%8F%8F%E8%BF%B0" target="_blank" rel="noopener noreferrer">MDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中明确描述：<em><strong>toFixed() 方法返回一个表示 numObj 的字符串，但不使用指数计数法，并且小数点后有精确到 digits 位的数字。如果需要截断，则将数字四舍五入；如果小数位数不足，则小数部分用零填充，以使其具有指定长度</strong></em>。</p> <p>但是在chrome中测试出现了奇葩结果：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token number">1.335</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 1.33 错误</span>
<span class="token number">1.345</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 1.34 错误</span>
<span class="token number">1.385</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 1.39 正确</span>
<span class="token number">1.395</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 1.40 正确</span>
</code></pre></div><p>所以，慎用<code>toFixed()</code>方法。</p> <h4 id="化整数运算"><a href="#化整数运算" class="header-anchor">#</a> 化整数运算</h4> <p>该方法的主要思路就是把，小数转化为整数再进行计算。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 小数点后面保留第 n 位
 *
 * @param x 做近似处理的数
 * @param n 小数点后第 n 位
 * @returns 近似处理后的数 
 */</span>
<span class="token keyword">function</span> <span class="token function">roundFractional</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>x <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>思路：n则是要保留的小数，先扩大10^n，用Math.round把计算结果向上取证处理（想向下取证则使用Math.floor函数），然后除以10^n。</p> <p>有了这个函数，那么我们要考虑的只剩下了在计算结果上保留几位小数的问题。加、减、乘、除计算变成下面的形式：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">roundFractional</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>x <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">0.1</span> <span class="token operator">+</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">roundFractional</span><span class="token punctuation">(</span><span class="token number">0.1</span> <span class="token operator">+</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 结果：0.3</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">0.1</span> <span class="token operator">*</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">roundFractional</span><span class="token punctuation">(</span><span class="token number">0.1</span> <span class="token operator">*</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 结果：0.02</span>
<span class="token comment">// 减法和除法依次类推，此处略掉两行</span>
</code></pre></div><h4 id="bignumber-js"><a href="#bignumber-js" class="header-anchor">#</a> bignumber.js</h4> <p>目前前端领域有很多工具都可以解决精度丢失以及大数计算的问题，比如<code>number-precision</code>，<code>bigDecimal.js</code>，但是我们最常用的还是 <a href="https://www.npmjs.com/package/bignumber.js" target="_blank" rel="noopener noreferrer">bignumber.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*** method **
 *  add / subtract / multiply /divide
 * floatObj.add(0.1, 0.2) &gt;&gt; 0.3
 * floatObj.multiply(19.9, 100) &gt;&gt; 1990
 *
 */</span>
<span class="token keyword">var</span> <span class="token function-variable function">floatObj</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">/*
     * 判断obj是否为一个整数
     */</span>
    <span class="token keyword">function</span> <span class="token function">isInteger</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">===</span> obj
    <span class="token punctuation">}</span>

    <span class="token comment">/*
     * 将一个浮点数转成整数，返回整数和倍数。如 3.14 &gt;&gt; 314，倍数是 100
     * @param floatNum {number} 小数
     * @return {object}
     *   {times:100, num: 314}
     */</span>
    <span class="token keyword">function</span> <span class="token function">toInteger</span><span class="token punctuation">(</span><span class="token parameter">floatNum</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> ret <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">times</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">num</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInteger</span><span class="token punctuation">(</span>floatNum<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ret<span class="token punctuation">.</span>num <span class="token operator">=</span> floatNum
            <span class="token keyword">return</span> ret
        <span class="token punctuation">}</span>
        <span class="token keyword">var</span> strfi  <span class="token operator">=</span> floatNum <span class="token operator">+</span> <span class="token string">''</span>
        <span class="token keyword">var</span> dotPos <span class="token operator">=</span> strfi<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span>
        <span class="token keyword">var</span> len    <span class="token operator">=</span> strfi<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>dotPos<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length
        <span class="token keyword">var</span> times  <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span>
        <span class="token keyword">var</span> intNum <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>floatNum<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        ret<span class="token punctuation">.</span>times  <span class="token operator">=</span> times
        ret<span class="token punctuation">.</span>num    <span class="token operator">=</span> intNum
        <span class="token keyword">return</span> ret
    <span class="token punctuation">}</span>

    <span class="token comment">/*
     * 核心方法，实现加减乘除运算，确保不丢失精度
     * 思路：把小数放大为整数（乘），进行算术运算，再缩小为小数（除）
     *
     * @param a {number} 运算数1
     * @param b {number} 运算数2
     * @param digits {number} 精度，保留的小数点数，比如 2, 即保留为两位小数
     * @param op {string} 运算类型，有加减乘除（add/subtract/multiply/divide）
     *
     */</span>
    <span class="token keyword">function</span> <span class="token function">operation</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> digits<span class="token punctuation">,</span> op</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> o1 <span class="token operator">=</span> <span class="token function">toInteger</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
        <span class="token keyword">var</span> o2 <span class="token operator">=</span> <span class="token function">toInteger</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
        <span class="token keyword">var</span> n1 <span class="token operator">=</span> o1<span class="token punctuation">.</span>num
        <span class="token keyword">var</span> n2 <span class="token operator">=</span> o2<span class="token punctuation">.</span>num
        <span class="token keyword">var</span> t1 <span class="token operator">=</span> o1<span class="token punctuation">.</span>times
        <span class="token keyword">var</span> t2 <span class="token operator">=</span> o2<span class="token punctuation">.</span>times
        <span class="token keyword">var</span> max <span class="token operator">=</span> t1 <span class="token operator">&gt;</span> t2 <span class="token operator">?</span> t1 <span class="token operator">:</span> t2
        <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>op<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">'add'</span><span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>t1 <span class="token operator">===</span> t2<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 两个小数位数相同</span>
                    result <span class="token operator">=</span> n1 <span class="token operator">+</span> n2
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>t1 <span class="token operator">&gt;</span> t2<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// o1 小数位 大于 o2</span>
                    result <span class="token operator">=</span> n1 <span class="token operator">+</span> n2 <span class="token operator">*</span> <span class="token punctuation">(</span>t1 <span class="token operator">/</span> t2<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// o1 小数位 小于 o2</span>
                    result <span class="token operator">=</span> n1 <span class="token operator">*</span> <span class="token punctuation">(</span>t2 <span class="token operator">/</span> t1<span class="token punctuation">)</span> <span class="token operator">+</span> n2
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> result <span class="token operator">/</span> max
            <span class="token keyword">case</span> <span class="token string">'subtract'</span><span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>t1 <span class="token operator">===</span> t2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    result <span class="token operator">=</span> n1 <span class="token operator">-</span> n2
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>t1 <span class="token operator">&gt;</span> t2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    result <span class="token operator">=</span> n1 <span class="token operator">-</span> n2 <span class="token operator">*</span> <span class="token punctuation">(</span>t1 <span class="token operator">/</span> t2<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    result <span class="token operator">=</span> n1 <span class="token operator">*</span> <span class="token punctuation">(</span>t2 <span class="token operator">/</span> t1<span class="token punctuation">)</span> <span class="token operator">-</span> n2
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> result <span class="token operator">/</span> max
            <span class="token keyword">case</span> <span class="token string">'multiply'</span><span class="token operator">:</span>
                result <span class="token operator">=</span> <span class="token punctuation">(</span>n1 <span class="token operator">*</span> n2<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>t1 <span class="token operator">*</span> t2<span class="token punctuation">)</span>
                <span class="token keyword">return</span> result
            <span class="token keyword">case</span> <span class="token string">'divide'</span><span class="token operator">:</span>
                result <span class="token operator">=</span> <span class="token punctuation">(</span>n1 <span class="token operator">/</span> n2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>t2 <span class="token operator">/</span> t1<span class="token punctuation">)</span>
                <span class="token keyword">return</span> result
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 加减乘除的四个接口</span>
    <span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> digits</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">operation</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> digits<span class="token punctuation">,</span> <span class="token string">'add'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">subtract</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> digits</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">operation</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> digits<span class="token punctuation">,</span> <span class="token string">'subtract'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">multiply</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> digits</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">operation</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> digits<span class="token punctuation">,</span> <span class="token string">'multiply'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">divide</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> digits</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">operation</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> digits<span class="token punctuation">,</span> <span class="token string">'divide'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// exports</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">add</span><span class="token operator">:</span> add<span class="token punctuation">,</span>
        <span class="token literal-property property">subtract</span><span class="token operator">:</span> subtract<span class="token punctuation">,</span>
        <span class="token literal-property property">multiply</span><span class="token operator">:</span> multiply<span class="token punctuation">,</span>
        <span class="token literal-property property">divide</span><span class="token operator">:</span> divide
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>大部分第三方库就是基于该方法进行封装，并且支持大数的处理。推荐使用。</p> <h2 id="参考文档"><a href="#参考文档" class="header-anchor">#</a> 参考文档</h2> <p><a href="https://blog.51cto.com/u_14562672/5802684" target="_blank" rel="noopener noreferrer">JS数字超限导致精度丢失问题原因及解决方案<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.cn/post/6844903572979597319" target="_blank" rel="noopener noreferrer">JS中浮点数精度问题<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.cn/post/7051103304780103716" target="_blank" rel="noopener noreferrer">javascript的精度问题，包含原因和解决方案-面试总结<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/js/multi-thread.html" class="prev">
        JS中的多线程编程
      </a></span> <span class="next"><a href="/blog/js/this.html">
        一文搞定this指向性问题
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.92dc81f6.js" defer></script><script src="/assets/js/2.2d54ebdc.js" defer></script><script src="/assets/js/6.c999d008.js" defer></script>
  </body>
</html>
